name: Build & Deploy CJ Spider

on:
  # 手动触发
  workflow_dispatch:
    inputs:
      branch:
        description: "选择分支"
        required: true
        default: "main"
        type: string
      version_type:
        description: "版本号类型"
        required: true
        default: "patch"
        type: choice
        options:
          - patch # 补丁版本 x.x.1 -> x.x.2
          - minor # 次版本   x.1.x -> x.2.0
          - major # 主版本   1.x.x -> 2.0.0

# 赋予工作流写入权限
permissions:
  contents: write

env:
  IMAGE_NAME: ${{ secrets.DOCKER_ALI_REGISTRY }}/tomorrowbye/cj-spider

jobs:
  # 计算版本号
  version:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.calc_version.outputs.new_version }}
      new_tag: ${{ steps.calc_version.outputs.new_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}
          fetch-depth: 0 # 获取所有历史和标签

      - name: Calculate new version
        id: calc_version
        run: |
          # 获取最新的版本标签
          LATEST_TAG=$(git tag -l "release-v*" --sort=-v:refname | head -n 1)

          if [ -z "$LATEST_TAG" ]; then
            # 没有标签，从 v1.0.0 开始
            CURRENT_VERSION="0.0.0"
          else
            # 提取版本号 (release-v1.0.0 -> 1.0.0)
            CURRENT_VERSION=${LATEST_TAG#release-v}
          fi

          echo "Current version: $CURRENT_VERSION"

          # 解析版本号
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

          # 根据类型递增版本号
          case "${{ inputs.version_type }}" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          NEW_TAG="release-v${NEW_VERSION}"

          echo "New version: $NEW_VERSION"
          echo "New tag: $NEW_TAG"

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT

  # 构建镜像
  build:
    runs-on: ubuntu-latest
    needs: version
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Ali Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.DOCKER_ALI_REGISTRY }}
          username: ${{ secrets.DOCKER_ALI_USERNAME }}
          password: ${{ secrets.DOCKER_ALI_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          platforms: linux/amd64
          tags: |
            ${{ env.IMAGE_NAME }}:${{ needs.version.outputs.new_version }}
            ${{ env.IMAGE_NAME }}:latest
          build-args: |
            NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
            NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false
          sbom: false

  # 创建标签
  tag:
    runs-on: ubuntu-latest
    needs: [version, build]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}

      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a ${{ needs.version.outputs.new_tag }} -m "Release ${{ needs.version.outputs.new_version }}"
          git push origin ${{ needs.version.outputs.new_tag }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.version.outputs.new_tag }}
          name: Release ${{ needs.version.outputs.new_version }}
          body: |
            ## CJ-Spider ${{ needs.version.outputs.new_version }}

            **分支**: ${{ inputs.branch }}
            **版本类型**: ${{ inputs.version_type }}
            **镜像**: `${{ env.IMAGE_NAME }}:${{ needs.version.outputs.new_version }}`

            ### 部署方式
            ```bash
            docker pull ${{ env.IMAGE_NAME }}:${{ needs.version.outputs.new_version }}
            ```
          draft: false
          prerelease: false

  # 部署
  deploy:
    runs-on: ubuntu-latest
    needs: [version, build, tag]
    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_SSH_HOST }}
          port: ${{ secrets.DEPLOY_SSH_PORT }}
          username: ${{ secrets.DEPLOY_SSH_USERNAME }}
          password: ${{ secrets.DEPLOY_SSH_PASSWORD }}
          script: |
            cd /home/wk/wakaja/
            docker compose -f ./docker-compose.yml pull cj-spider
            docker compose -f ./docker-compose.yml up cj-spider -d --force-recreate
            docker image prune -f

      - name: Deployment Success
        if: success()
        run: |
          echo "✅ CJ-Spider ${{ needs.version.outputs.new_version }} deployed successfully!"

      - name: Deployment Failure
        if: failure()
        run: |
          echo "❌ CJ-Spider deployment failed!"
